<%- include('partials/header'); -%>

<form action="/signup">
  <h2>Sign up</h2>

  <!-- Username -->
  <label for="username">Username</label>
  <input type="text" name="username" placeholder="Enter your username" required />
  <div class="username error"></div>

  <!-- First name -->
  <label for="firstname">First Name</label>
  <input type="text" name="firstname" placeholder="Enter your first name" required />

  <!-- Last name -->
  <label for="lastname">Last Name</label>
  <input type="text" name="lastname" placeholder="Enter your last name" required />

  <!-- Enaul -->
  <label for="email">Email</label>
  <input type="text" name="email" placeholder="Enter your email" required />
  <div class="email error"></div>

  <!-- Birth date -->
  <label for="birthday">Birth Date</label>
  <input type="date" id="birthday" name="birthday" required />
  <div class="birthday error"></div>

  <!-- Password & Confirm password-->
  <label for="password">Password</label>
  <input type="password" name="password" placeholder="Enter a password" required />

  <label for="confirmPassword">Confirm Password</label>
  <input type="password" name="confirmPassword" placeholder="Confirm password" required />

  <div class="password error"></div>

  <button>Sign up</button>
</form>

<%- include('partials/footer'); -%>

<script>
  // Get the form element.
  const form = document.querySelector("form");

  // Get the email error element.
  const emailError = document.querySelector(".email.error");

  // Get the password error element.
  const passwordError = document.querySelector(".password.error");

  // Get the username error element.
  const usernameError = document.querySelector(".username.error");

  // Get the birthday error element.
  const birthdayError = document.querySelector(".birthday.error");

  // Add an event listener to the form submit event.
  form.addEventListener("submit", async (e) => {
    // Prevent the default form submission.
    e.preventDefault();

    // Reset the error messages.
    emailError.textContent = "";
    passwordError.textContent = "";
    usernameError.textContent = "";
    birthdayError.textContent = "";

    // Get the form values.
    const username = form.username.value;
    const email = form.email.value;
    const password = form.password.value;
    const confirmPassword = form.confirmPassword.value;
    const firstname = form.firstname.value;
    const lastname = form.lastname.value;
    const birthday = form.birthday.value;

    // Validate the birth date.
    if (!isDateBeforeToday(birthday)) {
      birthdayError.textContent = "Choose Relevant Birthday ";
      return;
    }

    // Validate the password.
    if (password !== confirmPassword) {
      passwordError.textContent = "Password Not Matched!";
      return;
    }

    // Make an API call to the signup endpoint.
    const res = await fetch("/signup", {
      method: "POST",
      body: JSON.stringify({
        username,
        email,
        password,
        firstname,
        lastname,
        birthday,
      }),
      headers: { "Content-type": "application/json" },
    });

    // Get the response data.
    const data = await res.json();

    // Handle the response.
    if (data.error) {
      usernameError.textContent = data.error.username;
      emailError.textContent = data.error.email;
    } else if (data.user) {
      location.assign("/");
    } else if (data.status) {
      birthdayError.textContent = data.status;
    }

    console.log(data);
  });

  // Function to validate the birth date.
  function isDateBeforeToday(dateString) {
    // Parse the provided date string into a Date object.
    const providedDate = new Date(dateString);

    // Get the current date.
    const currentDate = new Date();

    // Set hours, minutes, seconds, and milliseconds to 0 for both dates.
    providedDate.setHours(0, 0, 0, 0);
    currentDate.setHours(0, 0, 0, 0);

    // Compare the two dates.
    return providedDate <= currentDate;
  }
</script>
