<%- include('partials/headerAdmin'); -%>

  <head>
    <title>Orders Managmenet</title>
  </head>

  <body>
    <h1>All Orders</h1>

    <% if (orders.length===0) { %>
      <p>No orders found.</p>
      <% } else { %>
        <form id="formDownload" action="/admin/allOrders/downloadOrdersData" method="get">
          <button type="submit">Download Orders Data</button>
        </form>
        <p id="status" style="color: red"></p>
        <table>
          <thead>
            <tr>
              <!-- <th>Order ID</th> -->
              <th>Order Date</th>
              <th>username</th>
              <th>Total Amount</th>
              <th>Payment Method</th>

              <th>Order Details</th>
              <th>Status</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            <% orders.forEach(order=> { %>
              <tr>
                <td>
                  <%= order.order_date.toLocaleDateString() %>
                </td>
                <td>
                  <%= order.userId.username %>
                </td>

                <td>$<%= order.total_amount.toFixed(2) %>
                </td>
                <td>
                  <%= order.payment.payment_method %>
                </td>

                <td>
                  <table>
                    <thead>
                      <tr>
                        <th>Product</th>
                        <th>Quantity</th>
                      </tr>
                    </thead>
                    <tbody>
                      <% order.items.forEach(item=> { %>
                        <tr>
                          <td>
                            <%= item.productId.name %>
                          </td>
                          <td>
                            <%= item.quantity %>
                          </td>
                        </tr>
                        <% }) %>
                    </tbody>
                  </table>
                </td>
                <td>
                  <%= order.status %>
                </td>
                <td>
                  <form class="MarkasReady" id="MarkasReady">
                    <button type="submit" data-id="<%= order._id %>" onclick="MarkasReady(event)">Mark as Ready</button>
                  </form>
                </td>
              </tr>
              <% }) %>
          </tbody>
        </table>
        <% } %>
          <script>
            document.getElementById("orderManage").style.backgroundColor = "#f9df4b"

            async function MarkasReady(event) {
              event.preventDefault();
              const status = document.getElementById("status");
              const id = event.target.getAttribute("data-id");
              console.log(id);
              status.textContent = "";
              //api call from frontend to server, sending data from form to server to save in db
              const res = await fetch(`http://localhost:3000/admin/allOrders/update-status/${id}`, {
                method: "POST",
                body: JSON.stringify(),
                headers: { "Content-type": "application/json" },
              });

              //after getting response from the server
              const data = await res.json();
              if (data.status) {
                status.textContent = data.status;
              } else if (data == "success") {
                window.location.reload();
              }
            }
          </script>
  </body>

  <%- include('partials/footer'); -%>